# Use Terraform's external data source to run PowerShell and return results directly
data "external" "fetch_apps" {
  program = ["powershell", "-Command"]
  
  query = {
    clientId     = var.client_id
    clientSecret = var.client_secret
    tenantId     = var.tenant_id
  }

  # Inline PowerShell script to fetch app names and return as JSON
  command = <<EOT
    $clientId = "${var.client_id}"
    $clientSecret = "${var.client_secret}"
    $tenantId = "${var.tenant_id}"

    # Login using SPN
    az login --service-principal --username $clientId --password $clientSecret --tenant $tenantId --only-show-errors | Out-Null

    # Fetch filtered app names
    $apps = az ad app list --query "[?starts_with(displayName, 'AC Azure') || starts_with(displayName, 'AC AWS')].{Name:displayName}" --output json | ConvertFrom-Json

    # Extract names and return as a JSON object (Terraform requires a key-value format)
    @{"app_names" = $apps | ForEach-Object { $_.Name }} | ConvertTo-Json -Compress
  EOT
}

# Store app names in a list variable
locals {
  app_names_list = data.external.fetch_apps.result.app_names
}

# Output (Optional) - Just for verification
output "app_names_list" {
  value = local.app_names_list
}